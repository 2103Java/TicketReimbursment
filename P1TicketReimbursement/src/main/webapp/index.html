<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
	integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
	crossorigin="anonymous">
<link href="style.css" rel="stylesheet">
<link href="loginStyle.css" rel="stylesheet">


<title>Document</title>
</head>
<body>



	<!--
    THIS IS THE LOGIN FORM
-->

	<h1 id="loginHeader">Welcome to the Ticket Reimbursement System</h1>
	<form id="loginForm">
		<div class="mb-3">
			<label for="exampleInputEmail1" class="form-label">Username</label> <input
				type="username" class="form-control" id="usernameLogin"
				aria-describedby="emailHelp">
		</div>

		<div class="mb-3">
			<label for="exampleInputPassword1" class="form-label">Password</label>
			<input type="password" class="form-control" id="passwordLogin">
		</div>

		<button type="button" class="btn btn-primary"
			onclick="login(document.getElementById('loginForm'))">Login</button>
	</form>


	<!--
    THIS IS FOR SUBMITTING NEW TICKETS
-->

	<div id="submitTicketForm" class="hidden">
		<form>
			<label for="TicketType">Ticket Type</label> <select id="TicketType"
				name="TicketType">
				<option value="LODGING">LODGING</option>
				<option value="TRAVEL">TRAVEL</option>
				<option value="FOOD" selected>FOOD</option>
				<option value="OTHER">OTHER</option>
			</select> <br> 
			<label for="amount">Amount to be reimbursed:</label> 
			<input type="number" id="amount" name="amount" min="1" max="10000">
			<br> <br> <br>


		</form>

		<button id="submitButton" onclick="submit()">Submit</button>
	</div>




	<!--
    THIS IS THE TABLE FOR SHOWING TICKETS FOR A USER
-->
	<div id="displayCurrTicket" class="hidden">

		<table style="width: 100%" id="TicketTable">
			<tr id="tableHeaders">
				<th>Type</th>
				<th>Amount</th>
				<th>Approved</th>
				<th>Date</th>
				<th>Ticket ID</th>
			</tr>
			<tr>
				<td id='ttype'>Jill</td>
				<td id='tamount'>Smith</td>
				<td id="tapproved">50</td>
				<td id="tdate">50</td>
				<td id="ticketID">50</td>
				<td id="currIndex" style="display:none">0</td>
				<td id="currLength" style="display:none">0</td>
				
			</tr>
			<tr>

			</tr>
		</table>
		<button id="nextTicket" onclick="">nextTicket</button>

	</div>

	<!--
    HOME PAGE BUTTONS
-->
	<div id="Choices" class="hidden">


		<div>
			<button id="ViewPreviousTickets" onclick="ViewPreviousTickets()">View
				Previous Tickets</button>
		</div>
		<div>
			<button id="SubmitNewTicket" onclick="submitNewTicket()">Submit <!-- DONE -->
				New Ticket</button> 
		</div>
		
		<div>
			<button id="logout" onclick="Logout()">Logout</button>
		</div>
		<div>
			<button id="ViewAllTickets" onclick="viewAllTickets()">ViewAllTickets</button>
		</div>
	</div>







	<script type="text/javascript">

    let user = null;


    //LOGIN FUNCTION
    function login(form) 
        {
    		
            console.log("Inside Login");
            var xhr = new XMLHttpRequest();
            
            xhr.onreadystatechange = function () {
            	
                if (xhr.readyState === 4) {
                    console.log(xhr.responseText);

                    console.log(this.getAllResponseHeaders());
                    if(xhr.status == 404){
                        alert('Login Failed!');
                        console.log('Login Failed!');
                    }
                    else{
                        alert("Login Successful!");
                        console.log("Login Successful!");
                        document.getElementById('loginHeader').classList.toggle('hidden');
                        
                        user = JSON.parse(xhr.responseText);
                        console.log(user.employeeID);
                        CheckWhichButtons();
                    }
                }
            }
            
            
            var loginParams ={
            		"username":form.usernameLogin.value,
            		"pass":form.passwordLogin.value
            }
    
            
            
			//I think for login we should go with synchronous request to await a response from the DB
            xhr.open("POST", 'http://localhost:9001/P1TicketReimbursement/Employee', true);
            xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8");
            xhr.send(JSON.stringify(loginParams));           
        }
    
    
    //  DEFAULT FUNCTION FOR CHECKING BUTTONS ON AND OFF
    function CheckWhichButtons(){
        console.log(user);
        if(user != null)
        {
        	document.getElementById("loginForm").classList.toggle('hidden');
            document.getElementById("Choices").classList.toggle('hidden');
            
            if(user.employment == "EMPLOYEE")
            {
            	document.getElementById("ViewAllTickets").classList.toggle('hidden');
            }     
        }
    }
    
    
    
    //SWITCHS VIEW FROM CHOICES TO SUBMIT TICKET FORM
    function submitNewTicket(){
    	document.getElementById("Choices").classList.toggle('hidden');
    	document.getElementById("submitTicketForm").classList.toggle('hidden');
    }

    //FUNCTION FOR SUBMITTING NEW TICKET -- NOT COMPLETED
    function submit() 
    {
        console.log("Inside Submit");
        var xhr = new XMLHttpRequest();
      
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                alert(xhr.response);
                document.getElementById("Choices").classList.toggle('hidden');
            	document.getElementById("submitTicketForm").classList.toggle('hidden');
            }
        }

        var type = document.getElementById('TicketType');
        
        let ticket ={
        		"type":type.options[type.selectedIndex].text,
        		"approval":'PENDING',
        		"amount":document.getElementById('amount').value,
        		"employeeID": user.employeeID
        }
        
        console.log(JSON.stringify(ticket));
        
        xhr.open("PUT", 'http://localhost:9001/P1TicketReimbursement/Ticket', true);
        xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8");
        console.log(JSON.stringify(ticket));
        xhr.send(JSON.stringify(ticket));
        
        
    }

    //LOGOUT FUNCTION 
    function Logout()
    {
        user = null;
        document.getElementById("loginForm").classList.toggle('hidden');
        document.getElementById("Choices").classList.toggle('hidden');

    }

    //FUNCTION FOR VIEWING ALL TICKETS FROM A USER -- NEEDS TO BE REFACTORED WHEN WE GET USERS STORED AS A JS OBJECT AND SHOULD BE PASSED INTO THIS FUNCTION I THINK
     function ViewPreviousTickets() 
     {
        console.log("Inside ViewPreviousTickets");
        
        var xhr = new XMLHttpRequest();
    	
        
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                let tickets = JSON.parse(xhr.response);
              
                for(let i = 0; i < tickets.ticketArr.length; i++){
                	tempDisplayTickets(tickets.ticketArr[i]);
                }
            
            }
        }

        
        xhr.open("GET", 'http://localhost:9001/P1TicketReimbursement/Ticket?employeeID='+user.employeeID, true);
        xhr.send();

                //THIS FUNCTION WORKS AND RETURNS A TICKET THEN INSERTS IT INTO A TABLE
                // IT WILL HAVE TO BE CHANGED WHEN WE GET LOGIN SET UP TO RETURN ALL TICKETS OF A USER INSTEAD OF JUST 1 TICKET AT A TIME
   
     }
    
     function sleep(ms) {
    	  return new Promise(resolve => setTimeout(resolve, ms));
    	}
    
    function tempDisplayTickets(ticket){
    	
    		
    		document.getElementById('ttype').textContent = ticket["type"];
    		document.getElementById('tamount').textContent = "'" + ticket["amount"]  +"'";
            document.getElementById('tapproved').textContent = ticket["approval"];
            document.getElementById('tdate').textContent = ticket["stamp"];
            document.getElementById('ticketID').textContent = "'" + ticket["ticketID"] +"'";
            document.getElementById('displayCurrTicket').classList.toggle('hidden');
            sleep(5000).then(()=>{});
    	
    	
    }
</script>

</body>
</html>